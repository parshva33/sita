<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growing Together - Sita's Decision Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            --primary: #007AFF;
            --primary-light: #5AC8FF;
            --primary-dark: #0051D5;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F2F2F7;
            --bg-tertiary: #EFEFEF;
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #8E8E93;
            --border: #D1D1D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1C1C1E;
                --bg-tertiary: #2C2C2E;
                --text-primary: #FFFFFF;
                --text-secondary: #E5E5EA;
                --text-tertiary: #8E8E93;
                --border: #39393D;
                --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100%;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
        }

        .header {
            background-color: var(--bg-primary);
            padding: 16px 20px 12px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .parent-indicator {
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
        }

        .main-content {
            flex: 1;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.2s ease;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: var(--bg-primary);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--bg-secondary);
        }

        .radio-item:hover, .checkbox-item:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--primary);
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .radio-label, .checkbox-label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
        }

        .btn {
            padding: 11px 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--primary);
            border: 1px solid var(--border);
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: color 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            gap: 0;
            background: var(--bg-primary);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-tertiary);
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-tertiary {
            color: var(--text-tertiary);
        }

        .mt-2 {
            margin-top: 16px;
        }

        .mb-2 {
            margin-bottom: 12px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .profile-summary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-stat {
            display: flex;
            gap: 32px;
            margin-top: 16px;
        }

        .profile-stat-item {
            flex: 1;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .profile-stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .decision-card {
            border-left: 4px solid var(--primary);
            cursor: pointer;
        }

        .decision-card:hover {
            box-shadow: var(--card-shadow-hover);
            border-color: var(--primary-light);
        }

        .decision-meta {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .welcome-hero {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .welcome-subtitle {
            font-size: 17px;
            color: var(--text-tertiary);
            margin-bottom: 32px;
        }

        .welcome-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            border: 1px solid var(--border);
        }

        .welcome-card p {
            font-size: 13px;
            color: var(--text-tertiary);
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }

            .header h1 {
                font-size: 24px;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>üå± Growing Together</h1>
                <div class="header-subtitle">Sita's Decision Engine</div>
                <div class="header-actions" id="headerActions"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active">
                <div class="welcome-hero">
                    <div class="welcome-icon">üå±</div>
                    <h2 class="welcome-title">Growing Together</h2>
                    <p class="welcome-subtitle">A caring space for parenting decisions</p>
                    
                    <div class="welcome-buttons">
                        <button class="btn btn-primary" id="btnParshva" style="padding: 12px;">
                            üë® I am Parshva
                        </button>
                        <button class="btn btn-primary" id="btnShalini" style="padding: 12px;">
                            üë© I am Shalini
                        </button>
                    </div>

                    <div class="welcome-card">
                        <p><strong>‚ú® How This Works:</strong> We'll ask thoughtful questions to help you understand Sita's needs better. Your answers matter, and they'll help guide us toward the best choices for her.</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div class="profile-summary">
                    <div class="profile-name" id="profileName">Welcome</div>
                    <div class="profile-stat">
                        <div class="profile-stat-item">
                            <div class="profile-stat-value" id="decisionCount">0</div>
                            <div class="profile-stat-label">Decisions Explored</div>
                        </div>
                        <div class="profile-stat-item">
                            <div class="profile-stat-value" id="pendingCount">0</div>
                            <div class="profile-stat-label">Awaiting Response</div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-button active" id="tabDecisions">üìã Our Journey</button>
                    <button class="tab-button" id="tabCreate">‚ûï New Conversation</button>
                </div>

                <!-- Decisions Tab -->
                <div id="decisionsTab" class="tab-content active">
                    <div id="decisionsList"></div>
                </div>

                <!-- Create Decision Tab -->
                <div id="createTab" class="tab-content">
                    <div class="card">
                        <h3 class="card-title">Let's Talk About Sita</h3>
                        <p class="text-tertiary mb-3">Share what's on your mind. We'll ask thoughtful follow-up questions to help you think through this together.</p>
                        
                        <form id="decisionForm">
                            <div class="form-group">
                                <label>What's the situation?</label>
                                <select id="decisionCategory" required>
                                    <option value="">Select a topic...</option>
                                    <option value="health">Health & Wellness</option>
                                    <option value="behavior">Behavior & Development</option>
                                    <option value="lifestyle">Daily Life & Routines</option>
                                    <option value="education">Learning & Growth</option>
                                    <option value="growth">Goals & Dreams</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Tell us more</label>
                                <textarea id="decisionDescription" placeholder="What's happening with Sita? The more you share, the better we can help." required></textarea>
                            </div>

                            <div id="screeningQuestionsContainer"></div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary btn-block">Continue</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Decision Detail Screen -->
            <div id="decisionDetailScreen" class="screen">
                <div id="decisionDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Signup -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Let's Get to Know You</h2>
                <button type="button" class="modal-close" id="btnModalClose">&times;</button>
            </div>
            <div id="signupContent"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = "https://hizgcdccqrqcbzukmxld.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_hcU_S7q5VwTeDjQn971gpw_YK2nUCYg";
        const SUPABASE_FUNCTION_URL = "https://hizgcdccqrqcbzukmxld.supabase.co/functions/v1/ai-screening-function";

        console.log("‚úÖ Configuration loaded");
        console.log("Supabase URL:", SUPABASE_URL);

        // ==================== APP STATE ====================
        const app = {
            currentParent: null,
            currentDecisionId: null,
            currentQuestionNumber: 0,
            currentAnswers: [],
            
            parents: {
                parshva: { name: 'Parshva', emoji: 'üë®', profile: {}, id: 'parshva' },
                shalini: { name: 'Shalini', emoji: 'üë©', profile: {}, id: 'shalini' }
            },
            
            decisions: [],

            profileQuestions: {
                health: [
                    { id: 'h1', q: "What's your top priority for Sita's wellbeing right now?", options: ['Sleep quality', 'Nutrition', 'Physical activity', 'Preventing illness', 'Development'] },
                    { id: 'h2', q: "How do you approach Sita's meals?", options: ['Home-cooked traditional', 'Balanced variety', 'Restrictive', 'Whatever she eats', 'Still figuring it out'] },
                    { id: 'h3', q: "What's your philosophy on bedtime?", options: ['Early & structured', 'Child-led', 'Flexible', 'I need rest too', 'It\'s a struggle'] },
                    { id: 'h4', q: "When Sita gets sick, what do you do?", options: ['Doctor quickly', 'Wait & see', 'Natural remedies', 'Follow pediatrician', 'Figure as we go'] },
                    { id: 'h5', q: "What development area concerns you most?", options: ['Language', 'Physical', 'Social', 'Emotions', 'Everything seems fine'] }
                ],
                behavior: [
                    { id: 'b1', q: "How do you handle Sita's big emotions?", options: ['Set boundaries', 'Prevent them', 'Give space', 'Depends on my mood', 'I struggle'] },
                    { id: 'b2', q: "What's your approach to guidance?", options: ['Natural consequences', 'Time-outs', 'Talk through', 'Mix of both', 'Inconsistent'] },
                    { id: 'b3', q: "How important is emotional expression to you?", options: ['Very important', 'Important with limits', 'Learn to manage', 'Unsure', 'Gut instinct'] },
                    { id: 'b4', q: "What behavior concerns you most?", options: ['Aggression', 'Talking back', 'Shyness', 'Too much energy', 'Nothing major'] },
                    { id: 'b5', q: "How should Sita handle disagreements?", options: ['Use words', 'Talk to adults', 'Work it out', 'Avoid conflict', 'Haven\'t thought'] }
                ],
                lifestyle: [
                    { id: 'l1', q: "What's your ideal daily rhythm for Sita?", options: ['Structured', 'Child-led', 'Mix', 'Whatever works', 'Managed chaos'] },
                    { id: 'l2', q: "How much screen time feels right?", options: ['Minimal only', '1-2 hours', 'Whatever works', 'Feel guilty', 'Don\'t monitor'] },
                    { id: 'l3', q: "What about outdoor play?", options: ['Daily', 'Regular', 'When we can', 'Weather dependent', 'Indoor easier'] },
                    { id: 'l4', q: "How are transitions for Sita?", options: ['Prep ahead', 'Go with flow', 'Hard for her', 'Use tools', 'Always negotiate'] },
                    { id: 'l5', q: "What's your parenting pace?", options: ['Thoughtful', 'Spontaneous', 'Practical', 'Just surviving', 'Finding balance'] }
                ],
                education: [
                    { id: 'e1', q: "What matters most in Sita's learning?", options: ['Academics', 'Curiosity', 'Life skills', 'Play-based', 'Too young'] },
                    { id: 'e2', q: "What learning environment appeals to you?", options: ['Traditional', 'Montessori', 'Play-based', 'Homeschool', 'Undecided'] },
                    { id: 'e3', q: "How do you feel about academic pressure?", options: ['Keep light', 'Some structure', 'Work hard', 'Worried', 'Too early'] },
                    { id: 'e4', q: "What's Sita's learning style?", options: ['Visual', 'Hands-on', 'Listening', 'Mix', 'Unsure'] },
                    { id: 'e5', q: "How involved do you want to be?", options: ['Very hands-on', 'Supportive', 'Prefer experts', 'As much as I can', 'Don\'t have time'] }
                ],
                growth: [
                    { id: 'g1', q: "What do you want Sita to learn this year?", options: ['Independence', 'Kindness', 'Problem-solving', 'Confidence', 'Happiness'] },
                    { id: 'g2', q: "How much independence should she have?", options: ['Try & learn', 'Protective', 'Too young', 'More each month', 'Unsure'] },
                    { id: 'g3', q: "What worries you about her future?", options: ['Pressure', 'Social', 'Mental health', 'Getting hurt', 'Preparation'] },
                    { id: 'g4', q: "What personality do you hope for?", options: ['Confident', 'Kind', 'Creative', 'Happy', 'Authentic'] },
                    { id: 'g5', q: "What does success in childhood mean?", options: ['Good grades', 'Happy', 'Pursuing interests', 'Good character', 'Everything'] }
                ]
            },

            init() {
                console.log("‚úÖ App initializing");
                this.loadData();
                this.attachEventListeners();
                console.log("‚úÖ App initialized successfully");
            },

            attachEventListeners() {
                console.log("Attaching event listeners...");
                
                // Welcome buttons
                const btnParshva = document.getElementById('btnParshva');
                const btnShalini = document.getElementById('btnShalini');
                
                if (btnParshva) {
                    btnParshva.addEventListener('click', () => {
                        console.log("Parshva button clicked");
                        this.selectParent('parshva');
                    });
                }
                
                if (btnShalini) {
                    btnShalini.addEventListener('click', () => {
                        console.log("Shalini button clicked");
                        this.selectParent('shalini');
                    });
                }

                // Tab buttons
                const tabDecisions = document.getElementById('tabDecisions');
                const tabCreate = document.getElementById('tabCreate');
                
                if (tabDecisions) {
                    tabDecisions.addEventListener('click', () => this.switchTab('decisions'));
                }
                
                if (tabCreate) {
                    tabCreate.addEventListener('click', () => this.switchTab('create'));
                }

                // Form submission
                const decisionForm = document.getElementById('decisionForm');
                if (decisionForm) {
                    decisionForm.addEventListener('submit', (e) => this.submitSituation(e));
                }

                // Modal close
                const btnModalClose = document.getElementById('btnModalClose');
                if (btnModalClose) {
                    btnModalClose.addEventListener('click', () => this.closeModal());
                }

                console.log("‚úÖ Event listeners attached");
            },

            saveData() {
                localStorage.setItem('sitaAppAI', JSON.stringify({
                    parents: this.parents,
                    decisions: this.decisions
                }));
            },

            loadData() {
                const saved = localStorage.getItem('sitaAppAI');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.parents = data.parents;
                    this.decisions = data.decisions;
                    console.log("‚úÖ Data loaded from localStorage");
                }
            },

            selectParent(parent) {
                console.log("Selecting parent:", parent);
                this.currentParent = parent;
                if (Object.keys(this.parents[parent].profile).length === 0) {
                    console.log("No profile found, showing signup modal");
                    this.showSignupModal(parent);
                } else {
                    console.log("Profile found, showing dashboard");
                    this.showDashboard();
                }
            },

            showSignupModal(parent) {
                console.log("Showing signup modal for", parent);
                const modal = document.getElementById('signupModal');
                const content = document.getElementById('signupContent');
                const parentObj = this.parents[parent];

                let html = '<form id="profileForm">';
                const categories = ['health', 'behavior', 'lifestyle', 'education', 'growth'];
                let totalQuestions = 0;

                categories.forEach(category => {
                    const categoryTitles = {
                        'health': 'üè• Health & Wellness',
                        'behavior': '‚ù§Ô∏è Behavior & Development',
                        'lifestyle': '‚è∞ Daily Life & Routines',
                        'education': 'üìö Learning & Growth',
                        'growth': 'üåü Goals & Dreams'
                    };

                    html += `<h3 style="margin-top: 20px; margin-bottom: 12px; font-size: 17px; font-weight: 600; color: var(--text-primary);">${categoryTitles[category]}</h3>`;
                    
                    this.profileQuestions[category].forEach((q, idx) => {
                        html += `<div class="form-group">
                            <label style="font-size: 14px;"><strong>${totalQuestions + 1}. ${q.q}</strong></label>
                            <div class="radio-group">`;
                        q.options.forEach(opt => {
                            const id = `${category}_${idx}_${opt.replace(/\s+/g, '_')}`;
                            html += `<label class="radio-item">
                                <input type="radio" name="${category}_${idx}" value="${opt}" required>
                                <span class="radio-label">${opt}</span>
                            </label>`;
                        });
                        html += `</div></div>`;
                        totalQuestions++;
                    });
                });

                html += '<div class="btn-group mt-2"><button type="submit" class="btn btn-primary btn-block">Create Your Profile</button></div></form>';
                content.innerHTML = html;
                modal.classList.add('active');

                // Attach form submit listener
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', (e) => this.saveProfile(e));
                }
            },

            saveProfile(event) {
                event.preventDefault();
                console.log("Saving profile");
                const categories = ['health', 'behavior', 'lifestyle', 'education', 'growth'];
                const profile = {};

                categories.forEach(category => {
                    profile[category] = {};
                    this.profileQuestions[category].forEach((q, idx) => {
                        const answer = document.querySelector(`input[name="${category}_${idx}"]:checked`)?.value || '';
                        profile[category][q.id] = answer;
                    });
                });

                this.parents[this.currentParent].profile = profile;
                this.saveData();
                this.closeModal();
                this.showDashboard();
            },

            closeModal() {
                console.log("Closing modal");
                document.getElementById('signupModal').classList.remove('active');
            },

            showDashboard() {
                console.log("Showing dashboard");
                document.getElementById('welcomeScreen').classList.remove('active');
                document.getElementById('dashboardScreen').classList.add('active');
                document.getElementById('decisionDetailScreen').classList.remove('active');

                const parent = this.parents[this.currentParent];
                document.getElementById('headerActions').innerHTML = `
                    <div class="parent-indicator">${parent.emoji} ${parent.name}</div>
                    <button class="btn btn-secondary" id="btnLogout">Logout</button>
                `;

                const btnLogout = document.getElementById('btnLogout');
                if (btnLogout) {
                    btnLogout.addEventListener('click', () => this.logout());
                }

                document.getElementById('profileName').textContent = `Hi, ${parent.name}`;
                document.getElementById('decisionCount').textContent = this.decisions.length;
                document.getElementById('pendingCount').textContent = this.decisions.filter(d => !d.responses[this.currentParent]).length;

                this.renderDecisions();
            },

            renderDecisions() {
                const container = document.getElementById('decisionsList');
                if (this.decisions.length === 0) {
                    container.innerHTML = `<div class="empty-state">
                        <div class="empty-state-icon">üåø</div>
                        <div class="empty-state-title">No conversations yet</div>
                        <p class="text-tertiary">Start by opening up about something you'd like to explore with Sita</p>
                    </div>`;
                    return;
                }

                container.innerHTML = this.decisions.map(d => {
                    const creator = this.parents[d.createdBy];
                    const otherParent = d.createdBy === 'parshva' ? 'shalini' : 'parshva';
                    const hasOtherResponse = d.responses[otherParent];

                    let status = 'pending';
                    let statusText = `Waiting for ${this.parents[otherParent].name}`;
                    if (hasOtherResponse) {
                        status = 'complete';
                        statusText = 'Both answered';
                    }

                    const cardHtml = `<div class="card decision-card" style="cursor: pointer;" data-decision-id="${d.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div class="card-title">${d.title}</div>
                                <div class="text-tertiary" style="margin-top: 4px; font-size: 14px;">${d.description.substring(0, 100)}...</div>
                            </div>
                        </div>
                        <div class="decision-meta">
                            <div class="decision-meta-item">üìå ${d.category}</div>
                        </div>
                    </div>`;

                    return cardHtml;
                }).join('');

                // Attach click listeners to decision cards
                document.querySelectorAll('.decision-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const decisionId = card.dataset.decisionId;
                        this.viewDecision(decisionId);
                    });
                });
            },

            submitSituation(event) {
                event.preventDefault();
                console.log("Submitting situation");

                const category = document.getElementById('decisionCategory').value;
                const description = document.getElementById('decisionDescription').value;

                const decision = {
                    id: 'decision_' + Date.now(),
                    title: description.substring(0, 50),
                    description: description,
                    category: category,
                    createdBy: this.currentParent,
                    createdAt: new Date().toISOString(),
                    responses: {},
                    analysis: null
                };

                this.decisions.push(decision);
                this.currentDecisionId = decision.id;
                this.currentQuestionNumber = 0;
                this.currentAnswers = [];
                this.saveData();

                this.generateNextQuestion();
            },

            async generateNextQuestion() {
                this.currentQuestionNumber++;
                console.log("Generating question", this.currentQuestionNumber);

                const container = document.getElementById('screeningQuestionsContainer');
                container.innerHTML = `
                    <div class="progress-container">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Question ${this.currentQuestionNumber} of 6</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(this.currentQuestionNumber / 6) * 100}%"></div>
                        </div>
                    </div>
                    <div class="spinner"></div>
                    <p class="text-tertiary" style="text-align: center; font-size: 14px; margin-top: 12px;">Thinking of the right question...</p>
                `;

                try {
                    const decision = this.decisions.find(d => d.id === this.currentDecisionId);
                    
                    const response = await fetch(SUPABASE_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            situation: decision.description,
                            parentType: this.currentParent,
                            previousAnswers: this.currentAnswers,
                            questionNumber: this.currentQuestionNumber,
                            parentProfile: this.parents[this.currentParent].profile
                        })
                    });

                    const data = await response.json();
                    console.log("Question response:", data);
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const question = data.question;
                    this.displayQuestion(question);

                } catch (error) {
                    console.error('Error generating question:', error);
                    container.innerHTML = `<div class="card" style="background: rgba(255, 59, 48, 0.05); border-color: var(--danger);">
                        <div style="color: var(--danger); font-weight: 600; font-size: 15px;">Couldn't generate question</div>
                        <div style="color: var(--text-tertiary); margin-top: 8px; font-size: 13px;">${error.message}</div>
                        <button class="btn btn-secondary mt-2" onclick="app.generateNextQuestion()" style="margin-top: 12px;">Try again</button>
                    </div>`;
                }
            },

            displayQuestion(question) {
                const container = document.getElementById('screeningQuestionsContainer');
                
                container.innerHTML = `
                    <div class="progress-container">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Question ${this.currentQuestionNumber} of 6</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(this.currentQuestionNumber / 6) * 100}%"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title" style="font-size: 17px; line-height: 1.6;">${question}</div>
                        <form id="questionForm">
                            <div class="form-group">
                                <label>Your thoughts:</label>
                                <textarea id="answerInput" placeholder="Share what comes to mind..." required style="min-height: 80px;"></textarea>
                            </div>
                            <div class="btn-group">
                                ${this.currentQuestionNumber > 1 ? `<button type="button" class="btn btn-secondary" id="btnBack">‚Üê Back</button>` : ''}
                                <button type="submit" class="btn btn-primary">${this.currentQuestionNumber < 6 ? 'Next ‚Üí' : 'Finish'}</button>
                            </div>
                        </form>
                    </div>
                `;

                const questionForm = document.getElementById('questionForm');
                if (questionForm) {
                    questionForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const answer = document.getElementById('answerInput').value;
                        this.submitAnswer(question, answer);
                    });
                }

                const btnBack = document.getElementById('btnBack');
                if (btnBack) {
                    btnBack.addEventListener('click', () => {
                        this.currentQuestionNumber--;
                        this.generateNextQuestion();
                    });
                }

                document.getElementById('answerInput')?.focus();
            },

            submitAnswer(question, answer) {
                console.log("Submitting answer to question:", question);
                this.currentAnswers.push({ question, answer });

                const decision = this.decisions.find(d => d.id === this.currentDecisionId);
                if (!decision.responses[this.currentParent]) {
                    decision.responses[this.currentParent] = [];
                }
                decision.responses[this.currentParent].push({ q: question, a: answer });

                this.saveData();

                if (this.currentQuestionNumber < 6) {
                    this.generateNextQuestion();
                } else {
                    this.showAnalysis();
                }
            },

            showAnalysis() {
                const decision = this.decisions.find(d => d.id === this.currentDecisionId);
                const container = document.getElementById('screeningQuestionsContainer');

                container.innerHTML = `
                    <div class="card" style="background: rgba(52, 199, 89, 0.05); border-color: var(--success);">
                        <div style="color: var(--success); font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 6px;">
                            <span>‚úì</span> All done!
                        </div>
                        <div style="color: var(--text-tertiary); margin-top: 8px; font-size: 14px;">
                            ${this.parents[decision.createdBy === this.currentParent ? 'shalini' : 'parshva'].name} will share their thoughts next.
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" id="btnBackToDash">Back to Conversations</button>
                    </div>
                `;

                const btnBackToDash = document.getElementById('btnBackToDash');
                if (btnBackToDash) {
                    btnBackToDash.addEventListener('click', () => this.showDashboard());
                }
            },

            viewDecision(decisionId) {
                console.log("Viewing decision:", decisionId);
                const decision = this.decisions.find(d => d.id === decisionId);
                if (!decision) return;

                const otherParent = decision.createdBy === 'parshva' ? 'shalini' : 'parshva';
                const myResponse = decision.responses[this.currentParent];
                const otherResponse = decision.responses[otherParent];
                const isCreator = decision.createdBy === this.currentParent;

                let html = `<button class="btn btn-secondary mb-3" id="btnBackToDecisions">‚Üê Back</button>`;
                
                html += `<div class="card">
                    <div class="card-title">${decision.title}</div>
                    <div class="text-tertiary" style="font-size: 15px; line-height: 1.6;">${decision.description}</div>
                    <div class="decision-meta mt-2">
                        <div class="decision-meta-item">üìå ${decision.category}</div>
                    </div>
                </div>`;

                if (myResponse) {
                    html += `<div class="card">
                        <div class="card-title">‚úì Your answers</div>
                        ${myResponse.map((qa, idx) => `
                            <div style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <h4 style="font-size: 14px; color: var(--primary); margin-bottom: 6px;">Q${idx + 1}</h4>
                                <p style="font-size: 13px; color: var(--text-tertiary); margin: 6px 0;">${qa.q}</p>
                                <p style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">${qa.a}</p>
                            </div>
                        `).join('')}
                    </div>`;
                } else if (!isCreator) {
                    html += `<div class="card" style="background: rgba(0, 122, 255, 0.05); border: 1px solid var(--primary);">
                        <div class="card-title" style="font-size: 17px;">Your turn</div>
                        <p class="text-tertiary mb-3" style="font-size: 14px;">Share your perspective so you can understand each other better.</p>
                        <button class="btn btn-primary" id="btnRespond">Answer Questions</button>
                    </div>`;
                }

                if (otherResponse) {
                    html += `<div class="card" style="border-left: 4px solid var(--success);">
                        <div class="card-title">‚úì ${this.parents[otherParent].name}'s answers</div>
                        ${otherResponse.map((qa, idx) => `
                            <div style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <h4 style="font-size: 14px; color: var(--primary); margin-bottom: 6px;">Q${idx + 1}</h4>
                                <p style="font-size: 13px; color: var(--text-tertiary); margin: 6px 0;">${qa.q}</p>
                                <p style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">${qa.a}</p>
                            </div>
                        `).join('')}
                    </div>`;
                }

                document.getElementById('decisionDetailContent').innerHTML = html;
                document.getElementById('welcomeScreen').classList.remove('active');
                document.getElementById('dashboardScreen').classList.remove('active');
                document.getElementById('decisionDetailScreen').classList.add('active');

                const btnBackToDecisions = document.getElementById('btnBackToDecisions');
                if (btnBackToDecisions) {
                    btnBackToDecisions.addEventListener('click', () => this.showDashboard());
                }

                const btnRespond = document.getElementById('btnRespond');
                if (btnRespond) {
                    btnRespond.addEventListener('click', () => this.respondToDecision(decisionId));
                }
            },

            respondToDecision(decisionId) {
                console.log("Responding to decision:", decisionId);
                this.currentDecisionId = decisionId;
                this.currentQuestionNumber = 0;
                this.currentAnswers = [];
                document.getElementById('decisionDetailScreen').classList.remove('active');
                document.getElementById('dashboardScreen').classList.add('active');
                this.switchTab('create');
                document.getElementById('decisionCategory').value = this.decisions.find(d => d.id === decisionId).category;
                document.getElementById('decisionDescription').value = this.decisions.find(d => d.id === decisionId).description;
                document.getElementById('decisionDescription').disabled = true;
                document.getElementById('decisionCategory').disabled = true;
                
                this.generateNextQuestion();
            },

            switchTab(tabName) {
                console.log("Switching tab to:", tabName);
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                if (tabName === 'decisions') {
                    document.getElementById('tabDecisions').classList.add('active');
                    document.getElementById('decisionsTab').classList.add('active');
                } else if (tabName === 'create') {
                    document.getElementById('tabCreate').classList.add('active');
                    document.getElementById('createTab').classList.add('active');
                }
            },

            logout() {
                console.log("Logging out");
                this.currentParent = null;
                document.getElementById('welcomeScreen').classList.add('active');
                document.getElementById('dashboardScreen').classList.remove('active');
                document.getElementById('decisionDetailScreen').classList.remove('active');
                document.getElementById('headerActions').innerHTML = '';
            }
        };

        // Initialize app when DOM is ready
        console.log("DOM Content Loaded, initializing app");
        app.init();
    </script>
</body>
</html>
